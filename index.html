<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Nota Online</title>
    <link rel="icon" href="data:,"> 

    <!-- Firebase SDK Versi Terbaru -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        /* Style CSS Anda sebelumnya */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        /* ... (sisanya sama dengan style sebelumnya) */
    </style>
</head>
<body>
    <div class="container">
        <div class="status-bar" id="status-bar">Status: Menghubungkan ke database...</div>
        
        <div class="tabs">
            <div class="tab active" onclick="openTab('createInvoice')">Buat Nota</div>
            <div class="tab" onclick="openTab('invoiceList')">Daftar Nota</div>
            <div class="tab" onclick="openTab('settings')">Pengaturan</div>
        </div>
        
        <!-- Sisa HTML sama seperti dokumen sebelumnya -->
        <!-- ... -->
    </div>

    <script>
        // Konfigurasi Firebase yang Lebih Aman
        const firebaseConfig = {
            apiKey: "GANTI_DENGAN_API_KEY_ANDA",
            authDomain: "GANTI_DENGAN_AUTH_DOMAIN_ANDA",
            projectId: "GANTI_DENGAN_PROJECT_ID_ANDA",
            storageBucket: "GANTI_DENGAN_STORAGE_BUCKET_ANDA",
            messagingSenderId: "GANTI_DENGAN_MESSAGING_SENDER_ID_ANDA",
            appId: "GANTI_DENGAN_APP_ID_ANDA"
        };

        // Variabel global untuk database
        let db;

        // Fungsi Update Status dengan Logging Tambahan
        function updateStatus(message, isError = false) {
            const statusBar = document.getElementById('status-bar');
            statusBar.textContent = 'Status: ' + message;
            statusBar.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
            statusBar.style.color = isError ? '#721c24' : '#155724';
            
            // Logging tambahan
            console.log(isError ? 'ERROR:' : 'STATUS:', message);
        }

        // Inisialisasi Firebase dengan Error Handling Lebih Baik
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase berhasil diinisialisasi");
            
            // Tes koneksi dengan timeout
            const connectionTestDoc = db.collection('connection-test').doc(Date.now().toString());
            
            connectionTestDoc.set({
                status: "Koneksi berhasil",
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                updateStatus("Terhubung ke database");
                
                // Hapus dokumen tes
                connectionTestDoc.delete().catch(console.error);
            })
            .catch(error => {
                console.error("Error koneksi:", error);
                updateStatus("Gagal terhubung ke database: " + error.message, true);
            });
        } catch (error) {
            console.error("Error inisialisasi Firebase:", error);
            updateStatus("Gagal menginisialisasi Firebase: " + error.message, true);
        }

        // Fungsi Simpan Nota dengan Validasi Lebih Ketat
        function saveInvoice() {
            updateStatus("Menyimpan nota...");
            
            // Validasi data sebelum simpan
            const invoiceNumber = document.getElementById('invoice-number').value;
            
            if (!invoiceNumber) {
                updateStatus("Nomor nota tidak boleh kosong!", true);
                return;
            }
            
            // Buat objek data invoice yang akan disimpan
            const invoiceData = {
                invoiceNumber: invoiceNumber,
                invoiceDate: document.getElementById('invoice-date').value,
                customerName: document.getElementById('customer-name').value || 'Pelanggan Umum',
                customerAddress: document.getElementById('customer-address').value || '',
                customerPhone: document.getElementById('customer-phone').value || '',
                paymentMethod: document.getElementById('payment-method').value,
                items: [],
                subtotal: parseFloat(document.getElementById('subtotal').innerHTML.replace('Rp ', '').replace(/\./g, '')),
                discount: parseFloat(document.getElementById('discount').value || 0),
                grandTotal: parseFloat(document.getElementById('grand-total').innerHTML.replace('Rp ', '').replace(/\./g, '')),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Validasi dan pengumpulan item
            const itemsTable = document.getElementById('items-body');
            for (let i = 0; i < itemsTable.rows.length; i++) {
                const itemName = itemsTable.rows[i].cells[1].querySelector('input').value || '';
                const itemQty = parseFloat(itemsTable.rows[i].cells[2].querySelector('input').value || 0);
                const itemPrice = parseFloat(itemsTable.rows[i].cells[3].querySelector('input').value || 0);
                
                if (itemName && itemQty > 0) {
                    invoiceData.items.push({
                        name: itemName,
                        quantity: itemQty,
                        price: itemPrice
                    });
                }
            }
            
            // Log data untuk debugging
            console.log("Data yang akan disimpan:", invoiceData);
            
            // Simpan data ke Firestore dengan error handling komprehensif
            db.collection('invoices').doc(invoiceData.invoiceNumber).set(invoiceData)
                .then(() => {
                    console.log("Nota berhasil disimpan");
                    updateStatus("Nota berhasil disimpan!");
                    
                    // Reset form untuk nota baru
                    const currentNumber = parseInt(invoiceData.invoiceNumber.replace('INV-', ''));
                    const nextNumber = 'INV-' + ('000' + (currentNumber + 1)).slice(-3);
                    document.getElementById('invoice-number').value = nextNumber;
                    
                    // Reset formulir
                    document.getElementById('customer-name').value = '';
                    document.getElementById('customer-address').value = '';
                    document.getElementById('customer-phone').value = '';
                    
                    // Hapus semua baris item
                    const itemsBody = document.getElementById('items-body');
                    while (itemsBody.rows.length > 0) {
                        itemsBody.deleteRow(0);
                    }
                    
                    // Tambahkan satu baris item kosong
                    addItem();
                    
                    // Reload daftar nota jika tab aktif
                    if (document.getElementById('invoiceList').classList.contains('active')) {
                        loadInvoiceList();
                    }
                })
                .catch((error) => {
                    // Error handling yang lebih detail
                    console.error("Error menyimpan nota:", {
                        code: error.code,
                        message: error.message,
                        details: error
                    });
                    updateStatus(`Gagal menyimpan nota: ${error.message}`, true);
                });
        }

        // Fungsi-fungsi lainnya tetap sama seperti dokumen sebelumnya
        // (addItem, removeItem, calculateItemTotal, calculateTotal, dll)

        // Saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Content Loaded");
            
            // Set tanggal hari ini
            document.getElementById('invoice-date').valueAsDate = new Date();
            
            // Inisialisasi tab handlers
            var tabs = document.getElementsByClassName('tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].onclick = function() {
                    var tabName = this.textContent.trim().toLowerCase().replace(/\s+/g, '');
                    openTab(tabName);
                };
            }
            
            // Muat pengaturan dengan penundaan singkat
            setTimeout(() => {
                loadSettings();
            }, 1000);
        });

        // Sisanya sama seperti dokumen HTML sebelumnya
        // (loadInvoiceList, viewInvoice, printInvoice, dll)
    </script>
</body>
</html>
